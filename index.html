<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Zikr & Vocabulary Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ASOSIY RANGLAR VA SOZLAMALAR --- */
        :root {
            --primary: #22c55e;
            --grad: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
            --danger: #ff4757;
            --bg: #f2f2f7;
            --text: #000000;
            --card: #ffffff;
            --border: #c6c6c8;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --switch-off: #e9e9ea;
            --icon-inactive: #999999;
            
            /* Suv ranglari (Yorqinroq va chiroyli) */
            --water-color: #38bdf8;
            --water-dark: #0ea5e9;
            --water-grad: linear-gradient(to top, #0284c7, #38bdf8);
        }

        body.dark-mode {
            --primary: #4ade80;
            --grad: linear-gradient(135deg, #4ade80 0%, #166534 100%);
            --bg: #000000;
            --text: #ffffff;
            --card: #1c1c1e;
            --border: #38383a;
            --nav-bg: rgba(30, 30, 30, 0.85);
            --switch-off: #39393d;
            --icon-inactive: #666666;
            --water-color: #0ea5e9; 
            --water-dark: #0369a1;
            --water-grad: linear-gradient(to top, #0c4a6e, #0ea5e9);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; transition: 0.3s;
        }

        #loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        #cloud-status {
            position: absolute; top: 15px; right: 15px; font-size: 12px; opacity: 0.7; display: flex; align-items: center; gap: 5px;
        }

        .page { 
            display: none !important; 
            flex: 1; flex-direction: column; 
            padding: 20px; overflow-y: auto; padding-bottom: 100px; align-items: center; 
        }
        .page.active { display: flex !important; }

        #page-view { justify-content: space-between; padding-bottom: 110px; }

        /* KARTALAR VA TUGMALAR */
        .card {
            background: var(--card); border-radius: 20px; padding: 20px; width: 100%;
            margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            text-align: center; transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99); }
        .card.locked { opacity: 0.6; background: rgba(128,128,128,0.1); cursor: not-allowed; display: flex; justify-content: space-between; align-items: center; }

        .btn { background: var(--grad); color: white; border: none; padding: 15px; width: 100%; border-radius: 15px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .btn.danger { background: var(--danger); box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        input { width: 100%; padding: 15px; background: var(--card); border: none; border-radius: 15px; color: var(--text); margin-bottom: 12px; outline: none; text-align: center; }

        /* Settings va Profil stillari */
        .settings-group { width: 100%; background: var(--card); border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--card); transition: 0.2s; }
        .switch-row:not(:last-child)::after { content: ''; position: absolute; bottom: 0; right: 0; width: calc(100% - 20px); height: 1px; background-color: var(--border); opacity: 0.5; }
        .switch-row:not(:last-child) { position: relative; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        .profile-stats-row { display: flex; gap: 15px; width: 100%; margin-bottom: 20px; }
        .p-stat-box { flex: 1; background: var(--card); padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: center; }
        .p-val { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .p-lbl { font-size: 12px; opacity: 0.6; }

        /* --- YANGILANGAN DOIRA VA SUV ANIMATSIYASI --- */
        .circle-wrapper {
            position: relative;
            width: 280px; height: 280px;
            min-width: 280px; min-height: 280px;
            border-radius: 50%; 
            background: var(--card);
            /* Ichki soya va tashqi soya - 3D effekt */
            box-shadow: 
                inset 10px 10px 20px rgba(0,0,0,0.1), 
                inset -5px -5px 15px rgba(255,255,255,0.5),
                0 15px 35px rgba(0,0,0,0.15),
                0 0 0 4px var(--card);
            border: 1px solid var(--border);
            overflow: hidden; cursor: pointer;
            margin-top: auto; margin-bottom: 40px;
            z-index: 1;
        }

        .main-word-display {
            font-size: 32px; font-weight: 800; text-align: center; color: var(--text);
            margin: 20px 0; line-height: 1.2; word-wrap: break-word; padding: 0 20px;
        }

        /* Suv qismi */
        .liquid-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            transition: height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 2;
        }

        .liquid-body {
            width: 100%; height: 100%;
            background: var(--water-grad);
        }

        /* To'lqinlar (2 qavat) */
        .wave {
            position: absolute; top: -15px; left: 0; width: 200%; height: 30px;
            background-repeat: repeat-x;
            background-size: 50% 100%;
            border-radius: 1000% 1000% 0 0;
            opacity: 1;
        }

        .wave-front {
            background-color: var(--water-color);
            animation: waveMove 4s linear infinite;
            z-index: 3;
            opacity: 0.8;
        }

        .wave-back {
            background-color: var(--water-dark);
            top: -20px;
            animation: waveMove 7s linear infinite reverse;
            z-index: 2;
            opacity: 0.5;
        }

        @keyframes waveMove { 
            0% { transform: translateX(0) scaleY(1); } 
            50% { transform: translateX(-25%) scaleY(0.8); }
            100% { transform: translateX(-50%) scaleY(1); } 
        }

        /* Tomchi (Droplet) */
        .droplet {
            position: absolute; top: -20px; left: 50%; 
            width: 14px; height: 14px;
            background: var(--water-color);
            border-radius: 0 50% 50% 50%; /* Haqiqiy tomchi shakli */
            transform: translateX(-50%) rotate(45deg); 
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            /* Animatsiya JS orqali boshqariladi */
        }

        /* Suv sachrashi (Splash particles) */
        .splash-particle {
            position: absolute; width: 6px; height: 6px;
            background: var(--water-color);
            border-radius: 50%;
            z-index: 6;
            pointer-events: none;
        }

        /* Yuzadagi halqa (Ripple) */
        .ripple {
            position: absolute; left: 50%; 
            width: 10px; height: 4px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 4;
            animation: rippleAnim 0.6s ease-out forwards;
        }
        @keyframes rippleAnim { to { transform: translate(-50%, -50%) scale(8); opacity: 0; border-width: 0; } }

        /* Shisha yaltirashi (Glass reflection) */
        .glass-shine {
            position: absolute; top: 10%; left: 10%; width: 40%; height: 20%;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; transform: rotate(-45deg);
            z-index: 10; pointer-events: none; filter: blur(2px);
        }

        /* Navigatsiya */
        .nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 70px;
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 25px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 100%; cursor: pointer;
            color: var(--icon-inactive); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item svg { width: 28px; height: 28px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { transform: translateY(-5px); filter: drop-shadow(0 5px 10px rgba(34, 197, 94, 0.4)); }
        .nav-dot { width: 5px; height: 5px; background: var(--primary); border-radius: 50%; margin-top: 5px; opacity: 0; transform: scale(0); transition: 0.3s; }
        .nav-item.active .nav-dot { opacity: 1; transform: scale(1); }
        .header-nav { width: 100%; display: flex; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .back-btn { font-size: 24px; padding-right: 15px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="loader"><h3>Yuklanmoqda...</h3></div>

    <div id="page-home" class="page active">
        <div id="cloud-status">‚òÅÔ∏è <span id="cloud-text">Oflayn</span></div>
        <h2 id="welcome-text" style="text-align:center">Assalomu alaykum</h2>
        <div class="card" onclick="navTo('page-create')" style="color:var(--primary); font-weight:bold; cursor:pointer; border: 2px dashed var(--primary); background: transparent;">
            + Yangi maqsad
        </div>
        <div id="list-container" style="width:100%"></div>
    </div> 
    
    <div id="page-create" class="page">
        <h2>Yangi Reja</h2>
        <input type="text" id="inp-name" placeholder="Nomi (masalan: Istig'for)">
        <input type="number" id="inp-total" placeholder="Jami soni (100)" oninput="calcDaily()">
        <input type="number" id="inp-days" placeholder="Kunlar (10)" oninput="calcDaily()">
        <div style="width:100%; text-align:center; margin:10px 0; opacity:0.8; font-size:14px">Kuniga (taxminan): <b id="lbl-daily">0</b> ta</div>
        <button class="btn" onclick="createItem()">Boshlash</button>
        <button class="btn" style="background:transparent; color:var(--text); border:1px solid var(--border)" onclick="navTo('page-home')">Bekor qilish</button>
    </div> 
    
    <div id="page-days" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-home')">‚¨ÖÔ∏è</span>
            <h3 id="days-title" style="margin:0">Kunlar</h3>
        </div>
        <div id="days-container" style="width:100%"></div>
    </div> 
    
    <div id="page-view" class="page">
        <div style="width:100%; flex-shrink: 0;">
            <div class="header-nav">
                <span class="back-btn" onclick="closeView()">‚¨ÖÔ∏è</span>
                <div style="flex:1"></div>
            </div>
            <p style="text-align:center; opacity:0.7; margin-bottom:5px">Bugungi reja: <b id="view-goal">0</b></p>
        </div>
        
        <div class="main-word-display" id="view-word-name">...</div>
        
        <div class="circle-wrapper" onclick="doCount()" id="circle-area">
            <div class="liquid-container" id="liq-container">
                <div class="wave wave-back"></div>
                <div class="wave wave-front"></div>
                <div class="liquid-body"></div>
            </div>
            <div class="glass-shine"></div>
        </div>
        
        <p style="text-align:center; font-size:12px; opacity:0.5; margin-bottom: 20px; flex-shrink: 0;">Sanash uchun doirani bosing</p>
    </div> 
    
    <div id="page-stats" class="page">
        <h2>Statistika</h2>
        <div id="completed-container" style="width:100%"></div>
    </div> 
    
    <div id="page-detail" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-stats')">‚¨ÖÔ∏è</span>
            <h3 id="detail-title" style="margin:0">Statistika</h3>
        </div>
        <div class="card">
            <div style="font-size:12px; opacity:0.7">Umumiy sarflangan vaqt:</div>
            <div style="font-size:24px; font-weight:bold; color:var(--primary)" id="detail-time">0 soat</div>
        </div>
        <div class="card" style="height: 250px;">
            <canvas id="timeChart"></canvas>
        </div>
        <button class="btn danger" onclick="deleteStatsItem()">üóë Statistikani o'chirish</button>
    </div> 
    
    <div id="page-profile" class="page">
        <h2>Profil</h2>
        <div style="width:80px; height:80px; background:#ddd; border-radius:50%; margin:20px; display:flex; align-items:center; justify-content:center; font-size:30px; object-fit:cover; overflow:hidden">
             <img id="u-ava-img" src="" style="width:100%; height:100%; display:none">
             <span id="u-ava-ph">üë§</span>
        </div>
        <h3 id="u-name" style="margin-top:0; margin-bottom: 25px;">Foydalanuvchi</h3>
        <div class="profile-stats-row">
            <div class="p-stat-box">
                <div class="p-val" id="p-life-count">0</div>
                <div class="p-lbl">Jami bosildi</div>
            </div>
            <div class="p-stat-box">
                <div class="p-val" id="p-life-time">0m</div>
                <div class="p-lbl">Umumiy vaqt</div>
            </div>
        </div>
        <div class="settings-group">
            <div class="switch-row">
                <span style="font-size:17px">Tungi rejim üåô</span>
                <label class="switch">
                    <input type="checkbox" id="tg-dark" onchange="toggleDark()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span style="font-size:17px">Vibratsiya üì≥</span>
                <label class="switch">
                    <input type="checkbox" id="tg-vib" onchange="toggleVib()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div> 
    
    <div class="nav">
        <div class="nav-item active" onclick="navTo('page-home')">
            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <div class="nav-dot"></div>
        </div>
        <div class="nav-item" onclick="navTo('page-stats')">
            <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            <div class="nav-dot"></div>
        </div>
        <div class="nav-item" onclick="navTo('page-profile')">
            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="nav-dot"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let items = [];
        let settings = { dark: false, vib: true };
        let lifetime = { count: 0, time: 0 }; 

        let currentItemId = null;
        let currentDayIndex = null;
        let sessionStart = 0;
        let chartInstance = null;
        let saveInterval = null;
        let isAnimating = false; // Bosishni cheklash uchun

        const CLOUD_KEY_ITEMS = 'zikr_data_v1';
        const CLOUD_KEY_SETTINGS = 'zikr_set_v1';
        const CLOUD_KEY_LIFE = 'zikr_life_v1';

        window.onload = function() {
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
            loadFromLocal();
            initUser();
            syncFromCloud();
            saveInterval = setInterval(saveAllData, 5000);
            window.addEventListener("beforeunload", () => { closeView(true); saveAllData(); });
        };

        function initUser() {
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                document.getElementById('u-name').innerText = u.first_name;
                document.getElementById('welcome-text').innerText = "Salom, " + u.first_name;
                if(u.photo_url) {
                    const img = document.getElementById('u-ava-img');
                    img.src = u.photo_url; img.style.display = 'block';
                    document.getElementById('u-ava-ph').style.display = 'none';
                }
            }
        }

        function loadFromLocal() {
            const d = localStorage.getItem('zikr_final_v14');
            const s = localStorage.getItem('zikr_settings_v14');
            const l = localStorage.getItem('zikr_lifetime_v16'); 
            if(d) try { items = JSON.parse(d); } catch(e) { items = []; }
            if(s) try { settings = JSON.parse(s); } catch(e) { settings = { dark: false, vib: true }; }
            if(l) try { lifetime = JSON.parse(l); } catch(e) { lifetime = { count: 0, time: 0 }; }
            cleanOldItems(); applySettings(); recalculateGoals(); renderList();
        }

        function cleanOldItems() {
            items.forEach(item => {
                const totalDone = item.progress.reduce((a, b) => a + b, 0);
                if (totalDone >= item.total) item.status = 'completed';
            });
        }

        function syncFromCloud() {
            document.getElementById('cloud-text').innerText = "Ulanmoqda...";
            if (!tg.CloudStorage) { document.getElementById('cloud-text').innerText = "Bulut yo'q"; return; }
            tg.CloudStorage.getItem([CLOUD_KEY_ITEMS, CLOUD_KEY_SETTINGS, CLOUD_KEY_LIFE], (err, res) => {
                if (!err && res) {
                    let hasNew = false;
                    if(res[CLOUD_KEY_ITEMS]) { items = JSON.parse(res[CLOUD_KEY_ITEMS]); hasNew = true; }
                    if(res[CLOUD_KEY_SETTINGS]) { settings = JSON.parse(res[CLOUD_KEY_SETTINGS]); hasNew = true; }
                    if(res[CLOUD_KEY_LIFE]) { lifetime = JSON.parse(res[CLOUD_KEY_LIFE]); hasNew = true; }
                    if(hasNew) { cleanOldItems(); applySettings(); recalculateGoals(); renderList(); updateProfileUI(); }
                    document.getElementById('cloud-text').innerText = "Sinxronlandi ‚úÖ";
                    document.getElementById('cloud-status').style.color = "var(--primary)";
                } else document.getElementById('cloud-text').innerText = "Xato/Bo'sh";
            });
        }

        function saveAllData() {
            localStorage.setItem('zikr_final_v14', JSON.stringify(items));
            localStorage.setItem('zikr_settings_v14', JSON.stringify(settings));
            localStorage.setItem('zikr_lifetime_v16', JSON.stringify(lifetime));
            if (tg.CloudStorage) {
                tg.CloudStorage.setItem(CLOUD_KEY_ITEMS, JSON.stringify(items));
                tg.CloudStorage.setItem(CLOUD_KEY_SETTINGS, JSON.stringify(settings));
                tg.CloudStorage.setItem(CLOUD_KEY_LIFE, JSON.stringify(lifetime));
            }
        }

        function recalculateGoals() {
            let changed = false; const today = new Date().setHours(0,0,0,0);
            items.forEach(item => {
                if (item.status === 'completed') return;
                const daysPassed = Math.floor((today - item.startDate) / (1000 * 60 * 60 * 24));
                if (daysPassed > 0 && daysPassed < item.durationDays) {
                    let doneInPast = 0; for(let i=0; i < daysPassed; i++) doneInPast += item.progress[i] || 0;
                    const rem = item.total - doneInPast; const dLeft = item.durationDays - daysPassed;
                    if (rem > 0 && dLeft > 0) {
                        const n = Math.ceil(rem / dLeft);
                        if (item.dailyGoal !== n) { item.dailyGoal = n; changed = true; }
                    }
                }
            });
            if (changed) saveAllData();
        }

        function calcDaily() {
            const t = parseInt(document.getElementById('inp-total').value) || 0;
            const d = parseInt(document.getElementById('inp-days').value) || 0;
            document.getElementById('lbl-daily').innerText = (t && d) ? Math.ceil(t/d) : 0;
        }

        function createItem() {
            const name = document.getElementById('inp-name').value;
            const total = parseInt(document.getElementById('inp-total').value);
            const days = parseInt(document.getElementById('inp-days').value);
            if(!name || !total || !days) return tg.showAlert("To'ldiring!");
            items.push({
                id: Date.now(), name: name, total: total, durationDays: days,
                dailyGoal: Math.ceil(total / days), startDate: new Date().setHours(0,0,0,0),
                progress: new Array(days).fill(0), totalTimeMs: 0, history: {}, status: 'active'
            });
            saveAllData();
            document.getElementById('inp-name').value = ''; document.getElementById('inp-total').value = ''; document.getElementById('inp-days').value = '';
            navTo('page-home');
        }

        function openDaysList(id) {
            currentItemId = id; const item = items.find(i => i.id === id);
            document.getElementById('days-title').innerText = item.name;
            const container = document.getElementById('days-container'); container.innerHTML = '';
            recalculateGoals();
            const today = new Date().setHours(0,0,0,0);
            const daysPassed = Math.floor((today - item.startDate) / (1000 * 60 * 60 * 24));
            for (let i = 0; i < item.durationDays; i++) {
                const dayNum = i + 1; const isLocked = i > daysPassed;
                const currentCount = item.progress[i];
                let icon = isLocked ? 'üîí' : (currentCount >= item.dailyGoal ? '‚úÖ' : 'üëâ');
                let st = isLocked ? 'Qulflangan' : `${currentCount} / ${item.dailyGoal}`;
                if(i === daysPassed) st = `Bugun: ${st}`;
                const div = document.createElement('div');
                div.className = `card ${isLocked?'locked':''}`;
                div.innerHTML = `<div style="font-weight:bold">${dayNum}-kun</div><div style="font-size:14px;opacity:0.7">${st}</div><div>${icon}</div>`;
                div.onclick = isLocked ? () => tg.showAlert("Hali vaqti kelmadi!") : () => openCounter(i);
                container.appendChild(div);
            }
            navTo('page-days');
        }

        function openCounter(dayIdx) {
            currentDayIndex = dayIdx; sessionStart = Date.now();
            const item = items.find(i => i.id === currentItemId);
            document.getElementById('view-word-name').innerText = item.name;
            document.getElementById('view-goal').innerText = item.dailyGoal;
            updateCircleUI(item);
            navTo('page-view');
        }

        // --- ASOSIY ANIMATSIYA LOGIKASI ---
        function doCount() {
            if (currentItemId === null || currentDayIndex === null) return;
            // Tez bosishni oldini olish (Animatsiya tugaguncha kutish shart emas, lekin vizual chalkashlik bo'lmasligi uchun)
            // Lekin foydalanuvchi tez bosishni xohlasa, buni o'chirib qo'yish mumkin. 
            // Hozirgi holatda har bir bosish alohida tomchi hosil qiladi.
            
            const item = items.find(i => i.id === currentItemId);
            if (item.progress[currentDayIndex] >= item.dailyGoal) return;

            // 1. Ma'lumotni yangilash
            item.progress[currentDayIndex]++;
            lifetime.count++;
            
            // 2. Vibratsiya
            if(settings.vib) try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
            
            // 3. Animatsiyani chaqirish
            triggerDropEffect(item);

            // 4. UI va saqlash
            saveAllData();
            
            if (item.progress[currentDayIndex] >= item.dailyGoal) {
                // Maqsadga yetganda oxirgi update
                setTimeout(() => updateCircleUI(item), 600); // Tomchi tushib bo'lgach suv ko'tariladi
                
                const allDone = item.progress.every(p => p >= item.dailyGoal);
                setTimeout(() => {
                    closeView(); 
                    if (allDone) {
                        item.status = 'completed'; saveAllData();
                        tg.showPopup({title:"Tabriklaymiz! üèÜ", message:"Barcha kunlar tugadi!"}, () => navTo('page-home'));
                    } else {
                        saveAllData(); openDaysList(currentItemId);
                    }
                }, 1500);
            } else {
                // Har bir bosishda suv darajasini biroz kechikib ko'tarish (realistik bo'lishi uchun)
                setTimeout(() => updateCircleUI(item), 500);
            }
        }

        function triggerDropEffect(item) {
            const wrapper = document.getElementById('circle-area');
            const liquid = document.getElementById('liq-container');
            
            // Hozirgi suv balandligini hisoblash (%)
            const cur = item.progress[currentDayIndex] - 1; // Hozirgi bosishdan oldingi holat
            const max = item.dailyGoal;
            let percent = (cur / max) * 100;
            if(percent > 100) percent = 100;
            if(percent < 5) percent = 5; // Juda past bo'lmasligi uchun

            // Tomchi yaratish
            const drop = document.createElement('div');
            drop.className = 'droplet';
            wrapper.appendChild(drop);

            // Tomchi tushish masofasini hisoblash (Suv yuzasigacha)
            // Konteyner balandligi 280px. 
            // Suv balandligi % da.
            // Tomchi tepadan (0px) suv yuzasiga (100% - percent%) tushishi kerak.
            
            // Animatsiya
            const fallDuration = 500; // ms
            const surfaceTop = 100 - percent; // % tepadan

            // Web Animation API dan foydalanamiz, aniqroq boshqarish uchun
            const anim = drop.animate([
                { top: '-20px', opacity: 1, transform: 'translateX(-50%) rotate(45deg) scale(1)' },
                { top: `calc(${surfaceTop}% - 10px)`, opacity: 1, transform: 'translateX(-50%) rotate(45deg) scale(0.8)' }
            ], {
                duration: fallDuration,
                easing: 'cubic-bezier(0.55, 0.06, 0.68, 0.19)' // Gravity effect (tezlashish)
            });

            anim.onfinish = () => {
                drop.remove();
                createSplash(surfaceTop);
            };
        }

        function createSplash(topPercent) {
            const wrapper = document.getElementById('circle-area');
            const liquid = document.getElementById('liq-container');

            // 1. Ripple (Halqa)
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.top = topPercent + '%';
            wrapper.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);

            // 2. Splash Particles (Sachrash) - Parchalanib ketish effekti
            const particleCount = 6;
            for(let i=0; i<particleCount; i++) {
                const p = document.createElement('div');
                p.className = 'splash-particle';
                p.style.top = topPercent + '%';
                p.style.left = '50%';
                wrapper.appendChild(p);

                // Tasodifiy yo'nalish
                const randomX = (Math.random() - 0.5) * 60; // -30px dan +30px gacha
                const randomY = -20 - Math.random() * 30;   // Yuqoriga uchish
                
                p.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${randomX}px, ${randomY}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 400 + Math.random() * 200,
                    easing: 'ease-out'
                }).onfinish = () => p.remove();
            }
        }

        function updateCircleUI(item) {
            const cur = item.progress[currentDayIndex];
            const max = item.dailyGoal;
            let ratio = cur / max;
            if (ratio > 1) ratio = 1;
            // Suv balandligini o'zgartirish
            document.getElementById('liq-container').style.height = (100 * ratio) + "%";
        }

        function closeView(isForce = false) {
            if (currentItemId && sessionStart > 0) {
                const diff = Date.now() - sessionStart;
                const item = items.find(i => i.id === currentItemId);
                if(item) {
                    item.totalTimeMs += diff; lifetime.time += diff;
                    const dKey = new Date().toISOString().split('T')[0];
                    item.history[dKey] = (item.history[dKey] || 0) + diff;
                    saveAllData();
                }
            }
            sessionStart = 0; 
            if(!isForce) { currentDayIndex = null; openDaysList(currentItemId); }
        }

        function deleteStatsItem() {
            if (!currentItemId) return;
            tg.showPopup({ title: "O'chirish", message: "Aniqmi?", buttons: [{id: 'd', type: 'destructive', text: "Ha"}, {id: 'c', type: 'cancel', text: "Yo'q"}] }, (id) => {
                if (id === 'd') { items = items.filter(i => i.id !== currentItemId); saveAllData(); currentItemId = null; navTo('page-stats'); }
            });
        }

        function renderList() {
            recalculateGoals();
            const div = document.getElementById('list-container'); div.innerHTML = '';
            const active = items.filter(i => i.status !== 'completed');
            if(active.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Maqsadlar yo\'q</p>';
            active.forEach(item => {
                const totalP = item.progress.reduce((a,b)=>a+b, 0);
                const percent = Math.floor((totalP / item.total) * 100);
                const el = document.createElement('div'); el.className = 'card'; el.onclick = () => openDaysList(item.id);
                el.innerHTML = `<h3>${item.name}</h3><div style="font-size:12px;opacity:0.7;margin-bottom:5px">Jami: ${totalP} / ${item.total}</div><div style="background:#e9e9ea;height:8px;border-radius:4px;overflow:hidden"><div style="width:${percent}%;background:var(--grad);height:100%"></div></div>`;
                div.appendChild(el);
            });
        }

        function renderStats() {
            const div = document.getElementById('completed-container'); div.innerHTML = '';
            const list = items.filter(i => i.status === 'completed');
            if(list.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Tarix bo\'sh</p>';
            list.forEach(item => {
                const el = document.createElement('div'); el.className = 'card'; el.style.background = 'rgba(34, 197, 94, 0.2)';
                el.onclick = () => showDetail(item.id);
                el.innerHTML = `<b>${item.name} ‚úÖ</b><br><span style="font-size:12px">Statistika</span>`;
                div.appendChild(el);
            });
        }

        function showDetail(id) {
            currentItemId = id; const item = items.find(i => i.id === id);
            document.getElementById('detail-title').innerText = item.name;
            document.getElementById('detail-time').innerText = Math.floor(item.totalTimeMs / 60000) + " daqiqa";
            navTo('page-detail');
            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            const clr = settings.dark ? '#fff' : '#000';
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(item.history), datasets: [{ label: 'Vaqt (daqiqa)', data: Object.values(item.history).map(ms => (ms/60000).toFixed(1)), backgroundColor: '#22c55e', borderRadius: 6 }] },
                options: { responsive:true, maintainAspectRatio:false, scales: { y: { ticks: { color: clr } }, x: { ticks: { color: clr } } }, plugins: { legend: { display: false } } }
            });
        }

        function updateProfileUI() {
            document.getElementById('p-life-count').innerText = lifetime.count;
            let tm = Math.floor(lifetime.time / 60000);
            document.getElementById('p-life-time').innerText = (tm > 60 ? Math.floor(tm/60)+"s " : "") + (tm%60) + "m";
        }

        function navTo(pid) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(pid==='page-home') { document.querySelectorAll('.nav-item')[0].classList.add('active'); renderList(); }
            if(pid==='page-stats') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderStats(); }
            if(pid==='page-profile') { document.querySelectorAll('.nav-item')[2].classList.add('active'); updateProfileUI(); }
        }
        
        function applySettings() {
            if(settings.dark) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            document.getElementById('tg-dark').checked = settings.dark; document.getElementById('tg-vib').checked = settings.vib;
            try { const c = getComputedStyle(document.body).getPropertyValue('--bg').trim(); tg.setHeaderColor(c); tg.setBackgroundColor(c); } catch(e){}
        }
        function toggleDark() { settings.dark = !settings.dark; applySettings(); saveAllData(); }
        function toggleVib() { settings.vib = !settings.vib; saveAllData(); }
    </script>
</body>
</html>

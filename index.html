<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Zikr & Vocabulary Green</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- RANGLAR O'ZGARTIRILDI (YASHIL) --- */
        :root {
            --primary: #22c55e; /* Asosiy jonli yashil */
            --grad: linear-gradient(135deg, #22c55e 0%, #059669 100%); /* Yashil gradient */
            --danger: #ff4757;
            --bg: #f2f2f7;
            --text: #000000;
            --card: #ffffff;
            --border: #c6c6c8;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --switch-off: #e9e9ea;
            --icon-inactive: #999999;
        }

        body.dark-mode {
            --primary: #4ade80; /* Tungi rejim uchun yorqinroq yashil */
            --grad: linear-gradient(135deg, #4ade80 0%, #34d399 100%); /* Tungi gradient */
            --bg: #000000;
            --text: #ffffff;
            --card: #1c1c1e;
            --border: #38383a;
            --nav-bg: rgba(30, 30, 30, 0.85);
            --switch-off: #39393d;
            --icon-inactive: #666666;
        }
        /* ---------------------------------------- */

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; transition: 0.3s;
        }

        #loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        .page { display: none; flex: 1; flex-direction: column; padding: 20px; overflow-y: auto; padding-bottom: 100px; align-items: center; }
        .page.active { display: flex; }

        .card {
            background: var(--card); border-radius: 20px; padding: 20px; width: 100%;
            margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            text-align: center; transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99); }
        .card.locked { opacity: 0.6; background: rgba(128,128,128,0.1); cursor: not-allowed; display: flex; justify-content: space-between; align-items: center; }

        /* Settings */
        .settings-group { width: 100%; background: var(--card); border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--card); transition: 0.2s; }
        .switch-row:not(:last-child)::after { content: ''; position: absolute; bottom: 0; right: 0; width: calc(100% - 20px); height: 1px; background-color: var(--border); opacity: 0.5; }
        .switch-row:not(:last-child) { position: relative; }

        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .btn { background: var(--grad); color: white; border: none; padding: 15px; width: 100%; border-radius: 15px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); } /* Shadow rangi ham yashil qilindi */
        .btn.danger { background: var(--danger); box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        
        input { width: 100%; padding: 15px; background: var(--card); border: none; border-radius: 15px; color: var(--text); margin-bottom: 12px; outline: none; text-align: center; }

        /* Water Animation */
        .water-container { width: 240px; height: 240px; margin: 30px auto; border-radius: 50%; background: var(--card); border: 4px solid var(--border); position: relative; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        .wave { position: absolute; width: 200%; height: 200%; background: var(--primary); left: -50%; top: var(--level, 110%); border-radius: 40%; animation: spin 6s linear infinite; transition: top 0.5s; opacity: 0.8; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .counter-text { z-index: 10; font-size: 48px; font-weight: 800; color: var(--text); mix-blend-mode: exclusion; transition: font-size 0.3s; }

        /* Navigation */
        .nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 70px;
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 25px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 100%; cursor: pointer;
            color: var(--icon-inactive); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item svg { width: 28px; height: 28px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { transform: translateY(-5px); filter: drop-shadow(0 5px 10px rgba(34, 197, 94, 0.4)); } /* Shadow yashil */
        .nav-dot { width: 5px; height: 5px; background: var(--primary); border-radius: 50%; margin-top: 5px; opacity: 0; transform: scale(0); transition: 0.3s; }
        .nav-item.active .nav-dot { opacity: 1; transform: scale(1); }

        .header-nav { width: 100%; display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { font-size: 24px; padding-right: 15px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="loader"><h3>Yuklanmoqda...</h3></div>

    <div id="page-home" class="page active">
        <h2 id="welcome-text" style="text-align:center">Assalomu alaykum</h2>
        <div class="card" onclick="navTo('page-create')" style="color:var(--primary); font-weight:bold; cursor:pointer; border: 2px dashed var(--primary); background: transparent;">
            + Yangi maqsad
        </div>
        <div id="list-container" style="width:100%"></div>
    </div>

    <div id="page-create" class="page">
        <h2>Yangi Reja</h2>
        <input type="text" id="inp-name" placeholder="Nomi (masalan: Istig'for)">
        <input type="number" id="inp-total" placeholder="Jami soni (100)" oninput="calcDaily()">
        <input type="number" id="inp-days" placeholder="Kunlar (10)" oninput="calcDaily()">
        <div style="width:100%; text-align:center; margin:10px 0; opacity:0.8; font-size:14px">Kuniga: <b id="lbl-daily">0</b> ta</div>
        <button class="btn" onclick="createItem()">Boshlash</button>
        <button class="btn" style="background:transparent; color:var(--text); border:1px solid var(--border)" onclick="navTo('page-home')">Bekor qilish</button>
    </div>

    <div id="page-days" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-home')">‚¨ÖÔ∏è</span>
            <h3 id="days-title" style="margin:0">Kunlar</h3>
        </div>
        <div id="days-container" style="width:100%"></div>
    </div>

    <div id="page-view" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="closeView()">‚¨ÖÔ∏è</span>
            <h3 id="view-title" style="margin:0">...</h3>
        </div>
        <p style="text-align:center; opacity:0.7">Bugungi reja: <b id="view-goal">0</b></p>
        
        <div class="water-container" onclick="doCount()">
            <div class="wave" id="wave"></div>
            <div class="counter-text" id="view-count">0</div>
        </div>
        <p style="text-align:center; font-size:12px; opacity:0.5">Sanash uchun bosing</p>
    </div>

    <div id="page-stats" class="page">
        <h2>Statistika</h2>
        <div id="completed-container" style="width:100%"></div>
    </div>

    <div id="page-detail" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-stats')">‚¨ÖÔ∏è</span>
            <h3 id="detail-title" style="margin:0">Statistika</h3>
        </div>
        <div class="card">
            <div style="font-size:12px; opacity:0.7">Umumiy sarflangan vaqt:</div>
            <div style="font-size:24px; font-weight:bold; color:var(--primary)" id="detail-time">0 soat</div>
        </div>
        <div class="card" style="height: 250px;">
            <canvas id="timeChart"></canvas>
        </div>
        <button class="btn danger" onclick="deleteStatsItem()">üóë Statistikani o'chirish</button>
    </div>

    <div id="page-profile" class="page">
        <h2>Profil</h2>
        <div style="width:80px; height:80px; background:#ddd; border-radius:50%; margin:20px; display:flex; align-items:center; justify-content:center; font-size:30px; object-fit:cover; overflow:hidden">
             <img id="u-ava-img" src="" style="width:100%; height:100%; display:none">
             <span id="u-ava-ph">üë§</span>
        </div>
        <h3 id="u-name" style="margin-top:0">Foydalanuvchi</h3>
        
        <div class="settings-group">
            <div class="switch-row">
                <span style="font-size:17px">Tungi rejim üåô</span>
                <label class="switch">
                    <input type="checkbox" id="tg-dark" onchange="toggleDark()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span style="font-size:17px">Vibratsiya üì≥</span>
                <label class="switch">
                    <input type="checkbox" id="tg-vib" onchange="toggleVib()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <p style="margin-top:20px; opacity:0.4; font-size:12px">v5.1 Green Edition</p>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="navTo('page-home')">
            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <div class="nav-dot"></div>
        </div>
        <div class="nav-item" onclick="navTo('page-stats')">
            <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            <div class="nav-dot"></div>
        </div>
        <div class="nav-item" onclick="navTo('page-profile')">
            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="nav-dot"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let items = [];
        let settings = { dark: false, vib: true };
        let currentItemId = null;
        let currentDayIndex = null;
        let sessionStart = 0;
        let chartInstance = null;

        window.onload = function() {
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
            loadData();
            initUser();
        };

        function initUser() {
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                document.getElementById('u-name').innerText = u.first_name;
                document.getElementById('welcome-text').innerText = "Salom, " + u.first_name;
                if(u.photo_url) {
                    const img = document.getElementById('u-ava-img');
                    img.src = u.photo_url; img.style.display = 'block';
                    document.getElementById('u-ava-ph').style.display = 'none';
                }
            }
        }

        function loadData() {
            // Ma'lumotlar bazasi nomini o'zgartirmadim, eski ma'lumotlar qolishi uchun
            const d = localStorage.getItem('zikr_final_v5');
            const s = localStorage.getItem('zikr_settings_v5');
            if(d) items = JSON.parse(d);
            if(s) settings = JSON.parse(s);
            applySettings();
            renderList();
        }
        function saveData() { localStorage.setItem('zikr_final_v5', JSON.stringify(items)); }
        function saveSettings() { localStorage.setItem('zikr_settings_v5', JSON.stringify(settings)); }

        function calcDaily() {
            const t = parseInt(document.getElementById('inp-total').value) || 0;
            const d = parseInt(document.getElementById('inp-days').value) || 0;
            document.getElementById('lbl-daily').innerText = (t && d) ? Math.ceil(t/d) : 0;
        }

        function createItem() {
            const name = document.getElementById('inp-name').value;
            const total = parseInt(document.getElementById('inp-total').value);
            const days = parseInt(document.getElementById('inp-days').value);
            
            if(!name || !total || !days) return tg.showAlert("To'ldiring!");

            const dailyGoal = Math.ceil(total / days);
            items.push({
                id: Date.now(), name: name, total: total, durationDays: days,
                dailyGoal: dailyGoal, startDate: new Date().setHours(0,0,0,0),
                progress: new Array(days).fill(0), totalTimeMs: 0, history: {}, status: 'active'
            });
            saveData();
            
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-total').value = '';
            document.getElementById('inp-days').value = '';
            navTo('page-home');
        }

        function openDaysList(id) {
            currentItemId = id;
            const item = items.find(i => i.id === id);
            document.getElementById('days-title').innerText = item.name;
            const container = document.getElementById('days-container');
            container.innerHTML = '';

            const today = new Date().setHours(0,0,0,0);
            const daysPassed = Math.floor((today - item.startDate) / (1000 * 60 * 60 * 24));

            for (let i = 0; i < item.durationDays; i++) {
                const dayNum = i + 1;
                const isLocked = i > daysPassed;
                const isCompleted = item.progress[i] >= item.dailyGoal;
                const currentCount = item.progress[i];
                
                let cardClass = 'card';
                let icon = 'üëâ';
                let statusText = `${currentCount} / ${item.dailyGoal}`;

                if (isLocked) { cardClass += ' locked'; icon = 'üîí'; statusText = 'Qulflangan'; } 
                else if (isCompleted) { icon = '‚úÖ'; statusText = 'Tugatildi'; }

                const div = document.createElement('div');
                div.className = cardClass;
                div.innerHTML = `<div style="font-weight:bold">${dayNum}-kun</div><div style="font-size:14px;opacity:0.7">${statusText}</div><div>${icon}</div>`;
                
                if (!isLocked) div.onclick = () => openCounter(i);
                else div.onclick = () => tg.showAlert(`${dayNum}-kun hali kelmadi!`);
                
                container.appendChild(div);
            }
            navTo('page-days');
        }

        function openCounter(dayIdx) {
            currentDayIndex = dayIdx;
            sessionStart = Date.now();
            const item = items.find(i => i.id === currentItemId);
            
            document.getElementById('view-title').innerText = `${item.name} (${dayIdx+1}-kun)`;
            document.getElementById('view-goal').innerText = item.dailyGoal;
            
            updateWaterUI(item);
            navTo('page-view');
        }

        function doCount() {
            if (currentItemId === null || currentDayIndex === null) return;
            const item = items.find(i => i.id === currentItemId);
            
            if (item.progress[currentDayIndex] >= item.dailyGoal) return;

            item.progress[currentDayIndex]++;
            if(settings.vib) try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}

            if (item.progress[currentDayIndex] >= item.dailyGoal) {
                item.progress[currentDayIndex] = item.dailyGoal;
                updateWaterUI(item); 
                saveData();
                
                const allDone = item.progress.every(p => p >= item.dailyGoal);
                
                setTimeout(() => {
                    closeView(); 
                    if (allDone) {
                        item.status = 'completed';
                        tg.showPopup({title:"Tabriklaymiz! üèÜ", message:"Barcha kunlar muvaffaqiyatli yakunlandi!", buttons:[{type:"ok"}]});
                    }
                }, 1200);
            } else {
                updateWaterUI(item);
                saveData();
            }
        }

        function updateWaterUI(item) {
            const cur = item.progress[currentDayIndex];
            const max = item.dailyGoal;
            const countEl = document.getElementById('view-count');
            
            if (cur >= max) {
                countEl.innerText = "Bajarildi! ‚úÖ";
                countEl.style.fontSize = "28px";
            } else {
                countEl.innerText = cur;
                countEl.style.fontSize = "48px";
            }

            let p = (cur / max) * 100;
            if (p > 100) p = 100;
            document.getElementById('wave').style.setProperty('--level', (110 - p) + "%");
        }

        function closeView() {
            if (currentItemId && sessionStart > 0) {
                const diff = Date.now() - sessionStart;
                const item = items.find(i => i.id === currentItemId);
                if(item) {
                    item.totalTimeMs += diff;
                    const dKey = new Date().toISOString().split('T')[0];
                    item.history[dKey] = (item.history[dKey] || 0) + diff;
                    saveData();
                }
            }
            sessionStart = 0; currentDayIndex = null;
            openDaysList(currentItemId);
        }

        function deleteStatsItem() {
            if (!currentItemId) return;
            tg.showPopup({
                title: "O'chirish",
                message: "Haqiqatan ham o'chirmoqchimisiz?",
                buttons: [{id: 'delete', type: 'destructive', text: "Ha"}, {id: 'cancel', type: 'cancel', text: "Yo'q"}]
            }, function(btnId) {
                if (btnId === 'delete') {
                    items = items.filter(i => i.id !== currentItemId);
                    saveData();
                    currentItemId = null;
                    navTo('page-stats');
                }
            });
        }

        function renderList() {
            const div = document.getElementById('list-container'); div.innerHTML = '';
            const active = items.filter(i => i.status !== 'completed');
            if(active.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Maqsadlar yo\'q</p>';
            
            active.forEach(item => {
                const totalP = item.progress.reduce((a,b)=>a+b, 0);
                const percent = Math.floor((totalP / item.total) * 100);
                const el = document.createElement('div'); el.className = 'card'; el.onclick = () => openDaysList(item.id);
                el.innerHTML = `<h3>${item.name}</h3><div style="font-size:12px;opacity:0.7;margin-bottom:5px">Jami: ${totalP} / ${item.total}</div><div style="background:#e9e9ea;height:8px;border-radius:4px;overflow:hidden"><div style="width:${percent}%;background:var(--grad);height:100%"></div></div>`;
                div.appendChild(el);
            });
        }

        function renderStats() {
            const div = document.getElementById('completed-container'); div.innerHTML = '';
            const list = items.filter(i => i.status === 'completed');
            if(list.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Tarix bo\'sh</p>';
            list.forEach(item => {
                const el = document.createElement('div'); el.className = 'card'; el.style.background = 'rgba(34, 197, 94, 0.2)'; /* Yashil fon */
                el.onclick = () => showDetail(item.id);
                el.innerHTML = `<b>${item.name} ‚úÖ</b><br><span style="font-size:12px">Statistika</span>`;
                div.appendChild(el);
            });
        }

        function showDetail(id) {
            currentItemId = id;
            const item = items.find(i => i.id === id);
            document.getElementById('detail-title').innerText = item.name;
            const m = Math.floor(item.totalTimeMs / 60000);
            document.getElementById('detail-time').innerText = m + " daqiqa";
            navTo('page-detail');
            
            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            const textColor = settings.dark ? '#fff' : '#000';
            
            // Grafik rangini ham yashil qilamiz
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(item.history), datasets: [{ label: 'Vaqt (daqiqa)', data: Object.values(item.history).map(ms => (ms/60000).toFixed(1)), backgroundColor: '#22c55e', borderRadius: 6 }] },
                options: { responsive:true, maintainAspectRatio:false, scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
            });
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            if(pageId === 'page-home') { document.querySelectorAll('.nav-item')[0].classList.add('active'); renderList(); }
            if(pageId === 'page-stats') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderStats(); }
            if(pageId === 'page-profile') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }
        
        function applySettings() {
            if(settings.dark) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            document.getElementById('tg-dark').checked = settings.dark; document.getElementById('tg-vib').checked = settings.vib;
            try { const c = getComputedStyle(document.body).getPropertyValue('--bg').trim(); tg.setHeaderColor(c); tg.setBackgroundColor(c); } catch(e){}
        }
        function toggleDark() { settings.dark = !settings.dark; applySettings(); saveSettings(); }
        function toggleVib() { settings.vib = !settings.vib; saveSettings(); }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zikr Cloud Safe</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === SIZNING DIZAYNINGIZ O‚ÄòZGARMAGAN === */
:root {
    --primary:#22c55e;
    --grad:linear-gradient(135deg,#22c55e,#15803d);
    --bg:#f2f2f7;
    --card:#fff;
    --text:#000;
}
body.dark-mode{
    --bg:#000;
    --card:#1c1c1e;
    --text:#fff;
}
body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont;
}
.page{display:none;padding:20px}
.page.active{display:block}
.card{
    background:var(--card);
    padding:15px;
    border-radius:15px;
    margin-bottom:10px;
}
.btn{
    width:100%;
    padding:14px;
    border:none;
    border-radius:14px;
    background:var(--grad);
    color:#fff;
    font-weight:600;
}
</style>
</head>

<body>

<div id="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--bg);z-index:9999">
<h3>Yuklanmoqda‚Ä¶</h3>
<p id="loader-msg" style="font-size:12px;opacity:.6">Cloud tekshirilmoqda</p>
</div>

<div id="page-home" class="page active">
<h2 id="welcome-text">Salom</h2>
<div id="list-container"></div>
</div>

<script>
/* =======================================================
   TELEGRAM INIT
======================================================= */
const tg = window.Telegram.WebApp;
tg.expand();

/* =======================================================
   GLOBAL STATE
======================================================= */
let items = [];
let settings = { dark:false, vib:true };
let lifetime = { count:0, time:0 };

let cloudReady = false;
let cloudHasData = false;
let saveInterval = null;

/* CLOUD KEYS */
const CLOUD_KEY_ITEMS = 'zikr_data_v1';
const CLOUD_KEY_SETTINGS = 'zikr_set_v1';
const CLOUD_KEY_LIFE = 'zikr_life_v1';

/* =======================================================
   INIT
======================================================= */
window.onload = () => {
    loadFromLocal();
    initUser();
    syncFromCloud();
};

/* =======================================================
   USER
======================================================= */
function initUser(){
    if(tg.initDataUnsafe?.user){
        document.getElementById('welcome-text').innerText =
        "Salom, " + tg.initDataUnsafe.user.first_name;
    }
}

/* =======================================================
   LOCAL LOAD
======================================================= */
function loadFromLocal(){
    try{
        items = JSON.parse(localStorage.getItem('zikr_final_v14')) || [];
        settings = JSON.parse(localStorage.getItem('zikr_settings_v14')) || settings;
        lifetime = JSON.parse(localStorage.getItem('zikr_lifetime_v16')) || lifetime;
    }catch(e){}
    applySettings();
    renderList();
}

/* =======================================================
   CLOUD SAFE SYNC (ASOSIY TUZATISH)
======================================================= */
function syncFromCloud(){
    if(!tg.CloudStorage){
        cloudReady = true;
        hideLoader();
        return;
    }

    tg.CloudStorage.getItem(
        [CLOUD_KEY_ITEMS, CLOUD_KEY_SETTINGS, CLOUD_KEY_LIFE],
        (err,res)=>{
            cloudReady = true;

            if(err || !res){
                console.warn("Cloud error");
                hideLoader();
                return;
            }

            let cItems=[], cSet=null, cLife=null;

            try{
                if(res[CLOUD_KEY_ITEMS]) cItems = JSON.parse(res[CLOUD_KEY_ITEMS]);
                if(res[CLOUD_KEY_SETTINGS]) cSet = JSON.parse(res[CLOUD_KEY_SETTINGS]);
                if(res[CLOUD_KEY_LIFE]) cLife = JSON.parse(res[CLOUD_KEY_LIFE]);
            }catch(e){}

            if(cItems.length > 0){
                cloudHasData = true;
                items = cItems;
                if(cSet) settings = cSet;
                if(cLife) lifetime = cLife;
                console.log("‚òÅÔ∏è Cloud ustun");
            }else{
                console.log("üì± Local ustun");
            }

            applySettings();
            renderList();
            hideLoader();

            if(saveInterval) clearInterval(saveInterval);
            saveInterval = setInterval(saveAllData,5000);
        }
    );
}

/* =======================================================
   SAFE SAVE
======================================================= */
function saveAllData(){
    localStorage.setItem('zikr_final_v14',JSON.stringify(items));
    localStorage.setItem('zikr_settings_v14',JSON.stringify(settings));
    localStorage.setItem('zikr_lifetime_v16',JSON.stringify(lifetime));

    if(!cloudReady) return;
    if(!cloudHasData && items.length===0) return;

    if(tg.CloudStorage){
        tg.CloudStorage.setItem(CLOUD_KEY_ITEMS,JSON.stringify(items));
        tg.CloudStorage.setItem(CLOUD_KEY_SETTINGS,JSON.stringify(settings));
        tg.CloudStorage.setItem(CLOUD_KEY_LIFE,JSON.stringify(lifetime));
    }
}

/* =======================================================
   UI
======================================================= */
function renderList(){
    const div=document.getElementById('list-container');
    div.innerHTML='';
    if(items.length===0){
        div.innerHTML='<p style="opacity:.5">Ma ºlumot yo‚Äòq</p>';
        return;
    }
    items.forEach(i=>{
        const el=document.createElement('div');
        el.className='card';
        el.innerText=i.name;
        div.appendChild(el);
    });
}

function applySettings(){
    document.body.classList.toggle('dark-mode',settings.dark);
    try{
        const bg=getComputedStyle(document.body).getPropertyValue('--bg');
        tg.setBackgroundColor(bg);
        tg.setHeaderColor(bg);
    }catch(e){}
}

function hideLoader(){
    document.getElementById('loader').style.display='none';
}
</script>

</body>
</html>

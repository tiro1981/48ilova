<script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Rangni sozlash (xatolik bo'lmasligi uchun try-catch)
        try {
            tg.setHeaderColor(getComputedStyle(document.body).getPropertyValue('--bg-color').trim());
            tg.setBackgroundColor(getComputedStyle(document.body).getPropertyValue('--bg-color').trim());
        } catch (e) { console.log("Rang sozlashda xato"); }

        // --- GLOBAL VARIABLES ---
        let items = [];
        let settings = { darkMode: false, haptic: true };
        
        let currentItemId = null;
        let viewStartTime = 0;
        let chartInstance = null;

        // --- APP START ---
        initApp();

        function initApp() {
            // 1. User ma'lumotlarini olish
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                document.getElementById('user-name').innerText = user.first_name;
                document.getElementById('home-name').innerText = user.first_name;
                if (user.photo_url) {
                    const els = ['user-photo', 'home-photo'];
                    const phs = ['user-photo-placeholder', 'home-photo-ph'];
                    els.forEach(id => {
                        const img = document.getElementById(id);
                        if(img) {
                            img.src = user.photo_url;
                            img.style.display = 'block';
                        }
                    });
                    phs.forEach(id => {
                        const p = document.getElementById(id);
                        if(p) p.style.display = 'none';
                    });
                }
            }

            // 2. Majburiy ochish (Sug'urta)
            // Agar CloudStorage 2 soniyada javob bermasa, baribir ilovani ochamiz
            setTimeout(() => {
                const loader = document.getElementById('loading-screen');
                if (loader && loader.style.display !== 'none') {
                    console.warn("CloudStorage kechikdi, majburiy ochilmoqda...");
                    loader.style.display = 'none';
                }
            }, 2500);

            // 3. Ma'lumotlarni yuklash (Cloud yoki Local)
            loadData();
        }

        function loadData() {
            // Agar CloudStorage mavjud bo'lsa (Telegram ichida)
            if (tg.CloudStorage && typeof tg.CloudStorage.getItem === 'function') {
                tg.CloudStorage.getItem(['my_items_cloud', 'app_settings_cloud'], (error, value) => {
                    if (!error && value) {
                        if (value.my_items_cloud) items = JSON.parse(value.my_items_cloud);
                        if (value.app_settings_cloud) settings = JSON.parse(value.app_settings_cloud);
                        applySettings();
                        renderList();
                    } else {
                        console.log("Cloud bo'sh yoki xato, LocalStorage tekshirilmoqda...");
                        loadFromLocal(); // Cloud ishlamasa lokalga o'tamiz
                    }
                    document.getElementById('loading-screen').style.display = 'none';
                });
            } else {
                // Brauzerda test qilish uchun
                console.log("Telegram Cloud yo'q, LocalStorage ishlatilmoqda.");
                loadFromLocal();
                document.getElementById('loading-screen').style.display = 'none';
            }
        }

        function loadFromLocal() {
            const localItems = localStorage.getItem('my_items_cloud');
            const localSettings = localStorage.getItem('app_settings_cloud');
            if (localItems) items = JSON.parse(localItems);
            if (localSettings) settings = JSON.parse(localSettings);
            applySettings();
            renderList();
        }

        // --- SAVE DATA (Hybrid: Cloud + Local) ---
        function saveData() {
            const dataStr = JSON.stringify(items);
            
            // 1. Localga yozish (tezkor)
            localStorage.setItem('my_items_cloud', dataStr);

            // 2. Cloudga yozish (agar mavjud bo'lsa)
            if (tg.CloudStorage && typeof tg.CloudStorage.setItem === 'function') {
                tg.CloudStorage.setItem('my_items_cloud', dataStr, (err) => {
                    if(err) console.error("Cloud save error:", err);
                });
            }
        }

        function saveSettings() {
            const setStr = JSON.stringify(settings);
            localStorage.setItem('app_settings_cloud', setStr);
            
            if (tg.CloudStorage && typeof tg.CloudStorage.setItem === 'function') {
                tg.CloudStorage.setItem('app_settings_cloud', setStr, (err) => {});
            }
        }

        // --- UI FUNCTIONS ---
        function applySettings() {
            if (settings.darkMode) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
            
            // Ranglarni yangilashga urinib ko'ramiz
            try {
                const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
                tg.setHeaderColor(bgColor);
                tg.setBackgroundColor(bgColor);
            } catch(e){}

            const tDark = document.getElementById('toggle-dark');
            const tHap = document.getElementById('toggle-haptic');
            if(tDark) tDark.checked = settings.darkMode;
            if(tHap) tHap.checked = settings.haptic;
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            if(target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(pageId === 'page-home') document.querySelectorAll('.nav-item')[0]?.classList.add('active');
            if(pageId === 'page-stats-list') {
                document.querySelectorAll('.nav-item')[1]?.classList.add('active');
                renderCompletedList();
            }
            if(pageId === 'page-profile') {
                document.querySelectorAll('.nav-item')[2]?.classList.add('active');
                updateProfileStats();
            }
        }

        // --- LOGIC ---
        function calculateDaily() {
            const total = parseFloat(document.getElementById('inp-total').value);
            const days = parseFloat(document.getElementById('inp-duration').value);
            if (total && days > 0) {
                document.getElementById('inp-daily').value = Math.ceil(total / days);
            }
        }

        function createItem() {
            const name = document.getElementById('inp-name').value;
            const total = parseInt(document.getElementById('inp-total').value);
            const daily = parseInt(document.getElementById('inp-daily').value);

            if (!name || !total || !daily) {
                tg.showAlert("Iltimos, barcha maydonlarni to'ldiring");
                return;
            }

            const newItem = {
                id: Date.now(),
                name: name,
                totalGoal: total,
                dailyGoal: daily,
                totalCount: 0,
                todayCount: 0,
                lastDate: new Date().toDateString(),
                status: 'active',
                timeSpentMs: 0,
                history: {}
            };
            items.push(newItem);
            saveData();
            
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-total').value = '';
            document.getElementById('inp-duration').value = '';
            document.getElementById('inp-daily').value = '';
            navTo('page-home');
        }

        function openView(id) {
            currentItemId = id;
            const item = items.find(i => i.id === id);
            if(!item) return;
            document.getElementById('view-name').innerText = item.name;
            document.getElementById('view-goal').innerText = item.dailyGoal;
            updateWater(item);
            viewStartTime = Date.now();
            navTo('page-view');
        }

        function closeView() {
            if (currentItemId && viewStartTime > 0) {
                const item = items.find(i => i.id === currentItemId);
                if(item) {
                    item.timeSpentMs += (Date.now() - viewStartTime);
                    saveData();
                }
            }
            viewStartTime = 0;
            navTo('page-home');
        }

        function incrementProgress() {
            if (!currentItemId) return;
            const item = items.find(i => i.id === currentItemId);
            if(!item) return;

            item.todayCount++;
            item.totalCount++;

            const todayKey = new Date().toISOString().split('T')[0];
            if (!item.history[todayKey]) item.history[todayKey] = 0;
            item.history[todayKey]++;

            if (settings.haptic) {
                try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
            }

            if (item.totalCount >= item.totalGoal) {
                item.status = 'completed';
                tg.showPopup({
                    title: 'Tabriklaymiz! ðŸŽ‰',
                    message: `Siz "${item.name}" maqsadini muvaffaqiyatli yakunladingiz!`,
                    buttons: [{type: 'ok'}]
                });
                closeView();
                return;
            }

            updateWater(item);
            saveData();
        }

        function updateWater(item) {
            const remaining = Math.max(0, item.dailyGoal - item.todayCount);
            document.getElementById('view-count').innerText = remaining;
            let percent = (item.todayCount / item.dailyGoal) * 100;
            if (percent > 100) percent = 100;
            document.querySelectorAll('.wave').forEach(w => {
                 w.style.setProperty('--level', `${110 - percent}%`);
            });
        }

        function renderList() {
            const container = document.getElementById('list-container');
            if(!container) return;
            container.innerHTML = '';
            const activeItems = items.filter(i => i.status !== 'completed');
            
            if (activeItems.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:var(--text-sub); margin-top:50px">Hozircha maqsadlar yo'q.<br>Yangi qo'shish uchun + tugmasini bosing.</div>`;
            }

            activeItems.forEach(item => {
                checkDate(item);
                const progress = item.totalGoal > 0 ? Math.min(100, Math.round((item.totalCount / item.totalGoal) * 100)) : 0;
                
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:flex-start">
                        <span>${item.name}</span>
                        <div style="width:100%; height:4px; background:#eee; border-radius:2px; margin-top:5px; width:100px; overflow:hidden">
                            <div style="height:100%; background:var(--primary-grad); width:${progress}%"></div>
                        </div>
                    </div>
                    <span>${progress}%</span>
                `;
                div.onclick = () => openView(item.id);
                container.appendChild(div);
            });
        }

        function renderCompletedList() {
            const container = document.getElementById('completed-list-container');
            if(!container) return;
            container.innerHTML = '';
            const list = items.filter(i => i.status === 'completed');
            if (list.length === 0) container.innerHTML = "<div style='color:var(--text-sub); text-align:center; margin-top:20px'>Tarix bo'sh</div>";
            
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item completed';
                div.innerHTML = `<span>${item.name}</span> <span>Yakunlandi âœ…</span>`;
                div.onclick = () => openStatsDetail(item.id);
                container.appendChild(div);
            });
        }

        function updateProfileStats() {
            let totalReps = 0;
            let totalCompleted = 0;
            items.forEach(i => {
                totalReps += i.totalCount || 0;
                if (i.status === 'completed') totalCompleted++;
            });
            const elReps = document.getElementById('total-reps-global');
            const elComp = document.getElementById('total-completed-global');
            const elLvl = document.getElementById('user-level');
            
            if(elReps) elReps.innerText = totalReps;
            if(elComp) elComp.innerText = totalCompleted;
            
            let level = "Boshlovchi";
            if (totalReps > 500) level = "Havaskor";
            if (totalReps > 2000) level = "Tajribali";
            if (totalReps > 10000) level = "Ustoz";
            if(elLvl) elLvl.innerText = level;
        }

        function toggleDarkMode() {
            settings.darkMode = !settings.darkMode;
            applySettings();
            saveSettings();
        }

        function toggleHaptic() {
            settings.haptic = !settings.haptic;
            saveSettings();
        }

        function openStatsDetail(id) {
            const item = items.find(i => i.id === id);
            if(!item) return;
            document.getElementById('stat-title').innerText = item.name;
            document.getElementById('stat-time').innerText = formatTime(item.timeSpentMs);
            
            const ctx = document.getElementById('myChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#dfe6e9' : '#2d3436';

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(item.history),
                    datasets: [{ 
                        label: 'Soni', 
                        data: Object.values(item.history), 
                        backgroundColor: '#6c5ce7',
                        borderRadius: 6
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: textColor } },
                        x: { ticks: { color: textColor } }
                    } 
                }
            });
            navTo('page-stats-detail');
        }

        function checkDate(item) {
            const today = new Date().toDateString();
            if (item.lastDate !== today) {
                item.todayCount = 0;
                item.lastDate = today;
            }
        }

        function formatTime(ms) {
            if(!ms) return "0 daqiqa";
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            return (h > 0 ? h + " soat " : "") + (m%60) + " daqiqa";
        }
    </script>

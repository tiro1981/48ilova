<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Zikr Cloud Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #22c55e;
            --grad: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
            --danger: #ff4757;
            --bg: #f2f2f7;
            --text: #000000;
            --card: #ffffff;
            --border: #c6c6c8;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --switch-off: #e9e9ea;
            --icon-inactive: #999999;
            --liquid-blue: #00BFFF; --liquid-surface-blue: #87CEFA;
        }
        body.dark-mode {
            --primary: #4ade80;
            --grad: linear-gradient(135deg, #4ade80 0%, #166534 100%);
            --bg: #000000;
            --text: #ffffff;
            --card: #1c1c1e;
            --border: #38383a;
            --nav-bg: rgba(30, 30, 30, 0.85);
            --switch-off: #39393d;
            --icon-inactive: #666666;
            --liquid-blue: #00BFFF; --liquid-surface-blue: #87CEFA;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; transition: 0.3s; }
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        #cloud-indicator { position: absolute; top: 15px; right: 15px; font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.05); padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.green { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .dot.red { background: #ff4757; }
        .dot.anim { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .page { display: none !important; flex: 1; flex-direction: column; padding: 20px; overflow-y: auto; padding-bottom: 100px; align-items: center; }
        .page.active { display: flex !important; }
        #page-view { justify-content: space-between; padding-bottom: 110px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); text-align: center; transition: transform 0.2s; }
        .card:active { transform: scale(0.99); }
        .card.locked { opacity: 0.6; background: rgba(128,128,128,0.1); cursor: not-allowed; display: flex; justify-content: space-between; align-items: center; }
        
        .settings-group { width: 100%; background: var(--card); border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--card); transition: 0.2s; }
        .switch-row:not(:last-child)::after { content: ''; position: absolute; bottom: 0; right: 0; width: calc(100% - 20px); height: 1px; background-color: var(--border); opacity: 0.5; }
        .switch-row:not(:last-child) { position: relative; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .btn { background: var(--grad); color: white; border: none; padding: 15px; width: 100%; border-radius: 15px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .btn.danger { background: var(--danger); box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        .btn.blue { background: #007aff; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); }
        
        input, textarea { width: 100%; padding: 15px; background: var(--card); border: none; border-radius: 15px; color: var(--text); margin-bottom: 12px; outline: none; text-align: center; }
        textarea { border: 1px solid var(--border); min-height: 80px; font-size: 12px; }

        .profile-stats-row { display: flex; gap: 15px; width: 100%; margin-bottom: 20px; }
        .p-stat-box { flex: 1; background: var(--card); padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: center; }
        .p-val { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .p-lbl { font-size: 12px; opacity: 0.6; }

        .circle-wrapper { position: relative; width: 280px; height: 280px; min-width: 280px; min-height: 280px; flex-shrink: 0; border-radius: 50%; background: var(--card); border: 4px solid var(--border); overflow: hidden; cursor: pointer; box-shadow: inset 0 0 40px rgba(0,0,0,0.05), 0 15px 35px rgba(0,0,0,0.1); margin-top: auto; margin-bottom: 40px; -webkit-mask-image: -webkit-radial-gradient(white, black); mask-image: radial-gradient(white, black); }
        .main-word-display { font-size: 32px; font-weight: 800; text-align: center; color: var(--text); margin: 20px 0; line-height: 1.2; word-wrap: break-word; padding: 0 20px; }
        .liquid-bottom { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: var(--liquid-blue); transition: height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 1; }
        .liquid-bottom::before { content: ''; position: absolute; top: -10px; left: 0; width: 100%; height: 20px; background: var(--liquid-surface-blue); border-radius: 50%; opacity: 0.7; animation: wave 2s infinite linear alternate; }
        @keyframes wave { from { transform: translateX(-2%) scaleY(0.8); } to { transform: translateX(2%) scaleY(1.2); } }
        .droplet { position: absolute; top: -15px; left: 50%; width: 12px; height: 12px; background: var(--liquid-blue); border-radius: 50% 50% 50% 0; transform: translateX(-50%) rotate(-45deg); z-index: 3; animation: dropFall 0.6s ease-in forwards; }
        @keyframes dropFall { to { top: 55%; opacity: 0; transform: translateX(-50%) rotate(-45deg) scale(0.4); } }
        .ripple { position: absolute; top: 0; left: 50%; width: 10px; height: 10px; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; transform: translate(-50%, -50%) scale(0); z-index: 4; animation: rippleAnim 0.6s ease-out forwards; }
        @keyframes rippleAnim { to { transform: translate(-50%, -50%) scale(5); opacity: 0; } }
        .glass-shine { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 25%); z-index: 10; pointer-events: none; }

        .nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; height: 70px; background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 100%; cursor: pointer; color: var(--icon-inactive); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-item svg { width: 28px; height: 28px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { transform: translateY(-5px); filter: drop-shadow(0 5px 10px rgba(34, 197, 94, 0.4)); }
        .nav-dot { width: 5px; height: 5px; background: var(--primary); border-radius: 50%; margin-top: 5px; opacity: 0; transform: scale(0); transition: 0.3s; }
        .nav-item.active .nav-dot { opacity: 1; transform: scale(1); }
        .header-nav { width: 100%; display: flex; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .back-btn { font-size: 24px; padding-right: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loader"><h3>Yuklanmoqda...</h3></div>

    <div id="page-home" class="page active">
        <div id="cloud-indicator"><div class="dot" id="c-dot"></div> <span id="c-text">Oflayn</span></div>

        <h2 id="welcome-text" style="text-align:center">Assalomu alaykum</h2>
        <div class="card" onclick="navTo('page-create')" style="color:var(--primary); font-weight:bold; cursor:pointer; border: 2px dashed var(--primary); background: transparent;">
            + Yangi maqsad
        </div>
        <div id="list-container" style="width:100%"></div>
    </div> 
    
    <div id="page-create" class="page">
        <h2>Yangi Reja</h2>
        <input type="text" id="inp-name" placeholder="Nomi">
        <input type="number" id="inp-total" placeholder="Jami" oninput="calcDaily()">
        <input type="number" id="inp-days" placeholder="Kunlar" oninput="calcDaily()">
        <div style="width:100%; text-align:center; margin:10px 0; opacity:0.8; font-size:14px">Kuniga: <b id="lbl-daily">0</b></div>
        <button class="btn" onclick="createItem()">Boshlash</button>
        <button class="btn" style="background:transparent; color:var(--text); border:1px solid var(--border)" onclick="navTo('page-home')">Bekor qilish</button>
    </div> 
    
    <div id="page-days" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-home')">‚¨ÖÔ∏è</span>
            <h3 id="days-title" style="margin:0">Kunlar</h3>
        </div>
        <div id="days-container" style="width:100%"></div>
    </div> 
    
    <div id="page-view" class="page">
        <div style="width:100%; flex-shrink: 0;">
            <div class="header-nav">
                <span class="back-btn" onclick="closeView()">‚¨ÖÔ∏è</span>
                <div style="flex:1"></div>
            </div>
            <p style="text-align:center; opacity:0.7; margin-bottom:5px">Bugungi reja: <b id="view-goal">0</b></p>
        </div>
        <div class="main-word-display" id="view-word-name">...</div>
        <div class="circle-wrapper" onclick="doCount()">
            <div class="liquid-bottom" id="liq-bottom"></div>
            <div class="glass-shine"></div>
        </div>
        <p style="text-align:center; font-size:12px; opacity:0.5; margin-bottom: 20px; flex-shrink: 0;">Sanash uchun doirani bosing</p>
    </div> 
    
    <div id="page-stats" class="page">
        <h2>Statistika</h2>
        <div id="completed-container" style="width:100%"></div>
    </div> 
    
    <div id="page-detail" class="page">
        <div class="header-nav">
            <span class="back-btn" onclick="navTo('page-stats')">‚¨ÖÔ∏è</span>
            <h3 id="detail-title" style="margin:0">Statistika</h3>
        </div>
        <div class="card">
            <div style="font-size:12px; opacity:0.7">Umumiy vaqt:</div>
            <div style="font-size:24px; font-weight:bold; color:var(--primary)" id="detail-time">0 soat</div>
        </div>
        <div class="card" style="height: 250px;">
            <canvas id="timeChart"></canvas>
        </div>
        <button class="btn danger" onclick="deleteStatsItem()">üóë O'chirish</button>
    </div> 
    
    <div id="page-profile" class="page">
        <h2>Profil</h2>
        <div style="width:80px; height:80px; background:#ddd; border-radius:50%; margin:20px; display:flex; align-items:center; justify-content:center; font-size:30px; object-fit:cover; overflow:hidden">
             <img id="u-ava-img" src="" style="width:100%; height:100%; display:none">
             <span id="u-ava-ph">üë§</span>
        </div>
        <h3 id="u-name" style="margin-top:0; margin-bottom: 25px;">Foydalanuvchi</h3>
        
        <div class="profile-stats-row">
            <div class="p-stat-box">
                <div class="p-val" id="p-life-count">0</div>
                <div class="p-lbl">Jami</div>
            </div>
            <div class="p-stat-box">
                <div class="p-val" id="p-life-time">0m</div>
                <div class="p-lbl">Vaqt</div>
            </div>
        </div>

        <div class="settings-group">
            <div class="switch-row">
                <span style="font-size:17px">Tungi rejim üåô</span>
                <label class="switch">
                    <input type="checkbox" id="tg-dark" onchange="toggleDark()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span style="font-size:17px">Vibratsiya üì≥</span>
                <label class="switch">
                    <input type="checkbox" id="tg-vib" onchange="toggleVib()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h3 style="margin-top:20px; margin-bottom:10px; font-size:16px">Sinxronizatsiya</h3>
        <button class="btn info" onclick="forceSync()">üîÑ Bulutni Yangilash (Cloud)</button>
        <div style="height:10px"></div>
        <button class="btn blue" style="background:#555; font-size:14px" onclick="toggleBackupTools()">üõ† Kod orqali o'tkazish (Backup)</button>
        
        <div id="backup-tools" style="display:none; margin-top:15px; background:var(--card); padding:10px; border-radius:15px; border:1px solid var(--border)">
            <p style="font-size:12px; margin:5px 0">Agar Cloud ishlamasa, bu koddan foydalaning:</p>
            <button class="btn" style="background:var(--primary); font-size:14px; padding:10px" onclick="exportData()">Kodni Nusxalash</button>
            <div style="height:10px"></div>
            <textarea id="import-area" placeholder="Kodni shu yerga tashlang..."></textarea>
            <button class="btn" style="background:var(--text); color:var(--bg); font-size:14px; padding:10px" onclick="importData()">Kodni Tiklash</button>
        </div>

        <p style="margin-top:20px; opacity:0.4; font-size:12px">v20.0 Ultimate Sync</p>
    </div> 
    
    <div class="nav">
        <div class="nav-item active" onclick="navTo('page-home')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><div class="nav-dot"></div></div>
        <div class="nav-item" onclick="navTo('page-stats')"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg><div class="nav-dot"></div></div>
        <div class="nav-item" onclick="navTo('page-profile')"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><div class="nav-dot"></div></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let items = [];
        let settings = { dark: false, vib: true };
        let lifetime = { count: 0, time: 0 }; 

        let currentItemId = null;
        let currentDayIndex = null;
        let sessionStart = 0;
        let chartInstance = null;
        let saveInterval = null;

        const C_KEY_DATA = 'z_data_20';
        const C_KEY_SET = 'z_set_20';
        const C_KEY_LIFE = 'z_life_20';

        // --- STATUS INDICATOR ---
        function setCloudStatus(status) {
            const d = document.getElementById('c-dot');
            const t = document.getElementById('c-text');
            d.className = 'dot';
            
            if(status === 'loading') { d.classList.add('anim'); t.innerText = 'Yuklanmoqda...'; }
            else if(status === 'ok') { d.classList.add('green'); t.innerText = 'Onlayn'; }
            else if(status === 'error') { d.classList.add('red'); t.innerText = 'Xato'; }
            else { t.innerText = 'Oflayn'; }
        }

        window.onload = function() {
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
            
            loadFromLocal();
            initUser();
            
            // Avtomatik Cloud Sync
            if(tg.CloudStorage) {
                setCloudStatus('loading');
                syncFromCloud();
            } else {
                setCloudStatus('off');
            }

            saveInterval = setInterval(saveAllData, 5000);
            window.addEventListener("beforeunload", () => { closeView(true); saveAllData(); });
        };

        function initUser() {
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                document.getElementById('u-name').innerText = u.first_name;
                document.getElementById('welcome-text').innerText = "Salom, " + u.first_name;
                if(u.photo_url) {
                    const img = document.getElementById('u-ava-img');
                    img.src = u.photo_url; img.style.display = 'block';
                    document.getElementById('u-ava-ph').style.display = 'none';
                }
            }
        }

        function loadFromLocal() {
            const d = localStorage.getItem(C_KEY_DATA);
            const s = localStorage.getItem(C_KEY_SET);
            const l = localStorage.getItem(C_KEY_LIFE);

            if(d) try { items = JSON.parse(d); } catch(e) { items = []; }
            if(s) try { settings = JSON.parse(s); } catch(e) { settings = { dark: false, vib: true }; }
            if(l) try { lifetime = JSON.parse(l); } catch(e) { lifetime = { count: 0, time: 0 }; }

            cleanOldItems();
            applySettings();
            recalculateGoals();
            renderList();
            updateProfileUI();
        }

        function cleanOldItems() {
            items.forEach(item => {
                const totalDone = item.progress.reduce((a, b) => a + b, 0);
                if (totalDone >= item.total) item.status = 'completed';
            });
        }

        // --- CLOUD LOGIC ---
        function syncFromCloud() {
            if (!tg.CloudStorage) return;
            
            tg.CloudStorage.getItem([C_KEY_DATA, C_KEY_SET, C_KEY_LIFE], (err, res) => {
                if (err) {
                    console.error(err);
                    setCloudStatus('error');
                } else if (res) {
                    let imported = false;
                    
                    if(res[C_KEY_DATA]) {
                        try { 
                            const cItems = JSON.parse(res[C_KEY_DATA]);
                            // Oddiy mantiq: Agar Cloud'da ko'proq element bo'lsa yoki local bo'sh bo'lsa
                            if(cItems.length >= items.length) { items = cItems; imported = true; }
                        } catch(e){}
                    }
                    if(res[C_KEY_SET]) {
                        try { settings = JSON.parse(res[C_KEY_SET]); imported = true; } catch(e){}
                    }
                    if(res[C_KEY_LIFE]) {
                        try { 
                            const cLife = JSON.parse(res[C_KEY_LIFE]);
                            if(cLife.count > lifetime.count) { lifetime = cLife; imported = true; }
                        } catch(e){}
                    }

                    if(imported) {
                        cleanOldItems(); applySettings(); recalculateGoals(); renderList(); updateProfileUI();
                    }
                    setCloudStatus('ok');
                }
            });
        }

        function saveAllData() {
            // Local
            localStorage.setItem(C_KEY_DATA, JSON.stringify(items));
            localStorage.setItem(C_KEY_SET, JSON.stringify(settings));
            localStorage.setItem(C_KEY_LIFE, JSON.stringify(lifetime));

            // Cloud
            if (tg.CloudStorage) {
                const sItems = JSON.stringify(items);
                if(sItems.length > 4096) {
                    setCloudStatus('error'); // Sig'madi
                    return;
                }
                tg.CloudStorage.setItem(C_KEY_DATA, sItems);
                tg.CloudStorage.setItem(C_KEY_SET, JSON.stringify(settings));
                tg.CloudStorage.setItem(C_KEY_LIFE, JSON.stringify(lifetime), (err, saved) => {
                    if(!err && saved) setCloudStatus('ok');
                });
            }
        }

        function forceSync() {
            setCloudStatus('loading');
            saveAllData();
            setTimeout(syncFromCloud, 1000);
        }

        // --- BACKUP TOOLS ---
        function toggleBackupTools() {
            const el = document.getElementById('backup-tools');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function exportData() {
            saveAllData();
            const dataObj = { i: items, s: settings, l: lifetime };
            const jsonStr = JSON.stringify(dataObj);
            const encoded = btoa(unescape(encodeURIComponent(jsonStr))); 
            
            const area = document.getElementById('import-area');
            area.value = encoded;
            area.select();
            try { 
                document.execCommand('copy'); 
                tg.showPopup({title:"Nusxalandi", message:"Kod nusxalandi! Endi uni ikkinchi telefonda 'Tiklash' ga qo'ying.", buttons:[{type:"ok"}]});
            } catch(e){
                tg.showAlert("Kodni o'zingiz nusxalab oling.");
            }
        }

        function importData() {
            const raw = document.getElementById('import-area').value;
            if(!raw) return tg.showAlert("Kod bo'sh!");
            try {
                const jsonStr = decodeURIComponent(escape(atob(raw)));
                const data = JSON.parse(jsonStr);
                if(data.i) items = data.i;
                if(data.s) settings = data.s;
                if(data.l) lifetime = data.l;
                
                saveAllData();
                loadFromLocal();
                toggleBackupTools();
                tg.showPopup({title:"Tayyor!", message:"Ma'lumotlar tiklandi ‚úÖ", buttons:[{type:"ok"}]});
            } catch(e) {
                tg.showAlert("Kod xato!");
            }
        }

        // --- QOLGAN MANTIQ ---
        function recalculateGoals() {
            let changed = false;
            const today = new Date().setHours(0,0,0,0);
            items.forEach(item => {
                if (item.status === 'completed') return;
                const daysPassed = Math.floor((today - item.startDate) / (1000 * 60 * 60 * 24));
                if (daysPassed > 0 && daysPassed < item.durationDays) {
                    let doneInPast = 0;
                    for(let i=0; i < daysPassed; i++) doneInPast += item.progress[i] || 0;
                    const totalRemaining = item.total - doneInPast;
                    const daysLeft = item.durationDays - daysPassed;
                    if (totalRemaining > 0 && daysLeft > 0) {
                        const newDailyGoal = Math.ceil(totalRemaining / daysLeft);
                        if (item.dailyGoal !== newDailyGoal) { item.dailyGoal = newDailyGoal; changed = true; }
                    }
                }
            });
            if (changed) saveAllData();
        }

        function calcDaily() {
            const t = parseInt(document.getElementById('inp-total').value) || 0;
            const d = parseInt(document.getElementById('inp-days').value) || 0;
            document.getElementById('lbl-daily').innerText = (t && d) ? Math.ceil(t/d) : 0;
        }

        function createItem() {
            const name = document.getElementById('inp-name').value;
            const total = parseInt(document.getElementById('inp-total').value);
            const days = parseInt(document.getElementById('inp-days').value);
            if(!name || !total || !days) return tg.showAlert("To'ldiring!");
            const dailyGoal = Math.ceil(total / days);
            items.push({
                id: Date.now(), name: name, total: total, durationDays: days,
                dailyGoal: dailyGoal, startDate: new Date().setHours(0,0,0,0),
                progress: new Array(days).fill(0), totalTimeMs: 0, history: {}, status: 'active'
            });
            saveAllData();
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-total').value = '';
            document.getElementById('inp-days').value = '';
            navTo('page-home');
        }

        function openDaysList(id) {
            currentItemId = id;
            const item = items.find(i => i.id === id);
            document.getElementById('days-title').innerText = item.name;
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            recalculateGoals();
            const today = new Date().setHours(0,0,0,0);
            const daysPassed = Math.floor((today - item.startDate) / (1000 * 60 * 60 * 24));
            for (let i = 0; i < item.durationDays; i++) {
                const dayNum = i + 1;
                const isLocked = i > daysPassed;
                const currentCount = item.progress[i];
                let targetForThisDay = item.dailyGoal; 
                let cardClass = 'card'; let icon = 'üëâ'; let statusText = `${currentCount} / ${targetForThisDay}`;
                if (isLocked) { cardClass += ' locked'; icon = 'üîí'; statusText = 'Qulflangan'; } 
                else if (currentCount >= targetForThisDay) { icon = '‚úÖ'; statusText = 'Tugatildi'; }
                else if (i === daysPassed) { statusText = `Bugun: ${currentCount} / ${targetForThisDay}`; }
                const div = document.createElement('div');
                div.className = cardClass;
                div.innerHTML = `<div style="font-weight:bold">${dayNum}-kun</div><div style="font-size:14px;opacity:0.7">${statusText}</div><div>${icon}</div>`;
                if (!isLocked) div.onclick = () => openCounter(i);
                else div.onclick = () => tg.showAlert(`${dayNum}-kun hali kelmadi!`);
                container.appendChild(div);
            }
            navTo('page-days');
        }

        function openCounter(dayIdx) {
            currentDayIndex = dayIdx;
            sessionStart = Date.now();
            const item = items.find(i => i.id === currentItemId);
            document.getElementById('view-word-name').innerText = item.name;
            document.getElementById('view-goal').innerText = item.dailyGoal;
            updateCircleUI(item);
            navTo('page-view');
        }

        function doCount() {
            if (currentItemId === null || currentDayIndex === null) return;
            const item = items.find(i => i.id === currentItemId);
            if (item.progress[currentDayIndex] >= item.dailyGoal) return;

            item.progress[currentDayIndex]++;
            lifetime.count++;
            
            saveAllData(); 
            if(settings.vib) try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
            createDroplets();

            if (item.progress[currentDayIndex] >= item.dailyGoal) {
                item.progress[currentDayIndex] = item.dailyGoal;
                updateCircleUI(item); saveAllData();
                const allDone = item.progress.every(p => p >= item.dailyGoal);
                setTimeout(() => {
                    closeView(); 
                    if (allDone) {
                        item.status = 'completed'; saveAllData();
                        tg.showPopup({title:"Tabriklaymiz! üèÜ", message:"Barcha kunlar muvaffaqiyatli yakunlandi!", buttons:[{type:"ok"}]}, function() {
                            navTo('page-home');
                        });
                    } else {
                        saveAllData(); openDaysList(currentItemId);
                    }
                }, 1200);
            } else {
                updateCircleUI(item); saveAllData();
            }
        }

        function createDroplets() {
            const wrapper = document.querySelector('.circle-wrapper');
            const bottomLiquid = document.getElementById('liq-bottom');
            for(let i=0; i<3; i++) {
                setTimeout(() => {
                    const drop = document.createElement('div');
                    drop.className = 'droplet';
                    drop.style.left = (50 + (Math.random() * 10 - 5)) + '%';
                    wrapper.appendChild(drop);
                    setTimeout(() => { drop.remove(); }, 500);
                    setTimeout(() => {
                        const ripple = document.createElement('div');
                        ripple.className = 'ripple';
                        ripple.style.left = (50 + (Math.random() * 6 - 3)) + '%';
                        bottomLiquid.appendChild(ripple);
                         setTimeout(() => { ripple.remove(); }, 600);
                    }, 450);
                }, i * 80);
            }
        }

        function updateCircleUI(item) {
            const cur = item.progress[currentDayIndex];
            const max = item.dailyGoal;
            let ratio = cur / max;
            if (ratio > 1) ratio = 1;
            document.getElementById('liq-bottom').style.height = (100 * ratio) + "%";
        }

        function closeView(isForce = false) {
            if (currentItemId && sessionStart > 0) {
                const diff = Date.now() - sessionStart;
                const item = items.find(i => i.id === currentItemId);
                if(item) {
                    item.totalTimeMs += diff;
                    lifetime.time += diff;
                    const dKey = new Date().toISOString().split('T')[0];
                    item.history[dKey] = (item.history[dKey] || 0) + diff;
                    saveAllData();
                }
            }
            sessionStart = 0; 
            if(!isForce) {
                currentDayIndex = null;
                openDaysList(currentItemId);
            }
        }

        function deleteStatsItem() {
            if (!currentItemId) return;
            tg.showPopup({
                title: "O'chirish",
                message: "Haqiqatan ham o'chirmoqchimisiz? (Umrbod statistikaga ta'sir qilmaydi)",
                buttons: [{id: 'delete', type: 'destructive', text: "Ha"}, {id: 'cancel', type: 'cancel', text: "Yo'q"}]
            }, function(btnId) {
                if (btnId === 'delete') {
                    items = items.filter(i => i.id !== currentItemId);
                    saveAllData();
                    currentItemId = null;
                    navTo('page-stats');
                }
            });
        }

        function renderList() {
            recalculateGoals();
            const div = document.getElementById('list-container'); div.innerHTML = '';
            const active = items.filter(i => i.status !== 'completed');
            if(active.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Maqsadlar yo\'q</p>';
            active.forEach(item => {
                const totalP = item.progress.reduce((a,b)=>a+b, 0);
                const percent = Math.floor((totalP / item.total) * 100);
                const el = document.createElement('div'); el.className = 'card'; el.onclick = () => openDaysList(item.id);
                el.innerHTML = `<h3>${item.name}</h3><div style="font-size:12px;opacity:0.7;margin-bottom:5px">Jami: ${totalP} / ${item.total}</div><div style="background:#e9e9ea;height:8px;border-radius:4px;overflow:hidden"><div style="width:${percent}%;background:var(--grad);height:100%"></div></div>`;
                div.appendChild(el);
            });
        }

        function renderStats() {
            const div = document.getElementById('completed-container'); div.innerHTML = '';
            const list = items.filter(i => i.status === 'completed');
            if(list.length === 0) div.innerHTML = '<p style="text-align:center;opacity:0.5">Tarix bo\'sh</p>';
            list.forEach(item => {
                const el = document.createElement('div'); el.className = 'card'; el.style.background = 'rgba(34, 197, 94, 0.2)';
                el.onclick = () => showDetail(item.id);
                el.innerHTML = `<b>${item.name} ‚úÖ</b><br><span style="font-size:12px">Statistika</span>`;
                div.appendChild(el);
            });
        }

        function showDetail(id) {
            currentItemId = id;
            const item = items.find(i => i.id === id);
            document.getElementById('detail-title').innerText = item.name;
            const m = Math.floor(item.totalTimeMs / 60000);
            document.getElementById('detail-time').innerText = m + " daqiqa";
            navTo('page-detail');
            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            const textColor = settings.dark ? '#fff' : '#000';
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(item.history), datasets: [{ label: 'Vaqt (daqiqa)', data: Object.values(item.history).map(ms => (ms/60000).toFixed(1)), backgroundColor: '#22c55e', borderRadius: 6 }] },
                options: { responsive:true, maintainAspectRatio:false, scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
            });
        }

        function updateProfileUI() {
            document.getElementById('p-life-count').innerText = lifetime.count;
            let totalMin = Math.floor(lifetime.time / 60000);
            let h = Math.floor(totalMin / 60);
            let m = totalMin % 60;
            let timeText = "";
            if (h > 0) timeText += h + "s ";
            timeText += m + "m";
            document.getElementById('p-life-time').innerText = timeText;
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            if(pageId === 'page-home') { document.querySelectorAll('.nav-item')[0].classList.add('active'); renderList(); }
            if(pageId === 'page-stats') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderStats(); }
            if(pageId === 'page-profile') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                updateProfileUI(); 
            }
        }
        
        function applySettings() {
            if(settings.dark) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            document.getElementById('tg-dark').checked = settings.dark; document.getElementById('tg-vib').checked = settings.vib;
            try { const c = getComputedStyle(document.body).getPropertyValue('--bg').trim(); tg.setHeaderColor(c); tg.setBackgroundColor(c); } catch(e){}
        }
        function toggleDark() { settings.dark = !settings.dark; applySettings(); saveAllData(); }
        function toggleVib() { settings.vib = !settings.vib; saveAllData(); }

    </script>
</body>
</html>
